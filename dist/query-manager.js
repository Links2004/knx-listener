"use strict";
const tslib_1 = require("tslib");
const async_socket_1 = require("./utils/async-socket");
const smart_cursor_1 = require("./utils/smart-cursor");
const deserializer_1 = require("./deserializer");
const serializer_1 = require("./serializer");
class QueryManager extends async_socket_1.AsyncSocket {
    connect(port = 0) {
        const ref = super.on('raw', this.process.bind(this));
        return super.connect(port).catch((err) => {
            ref.unsubscribe();
            throw err;
        });
    }
    request(host, port, data, select, timeout) {
        return new Promise((resolve, reject) => {
            const ref = this.on('query', (query, remote) => {
                if (select(query, remote)) {
                    if (query.status === 0) {
                        resolve(query);
                    }
                    else {
                        reject(new Error(`Request error ${query.status}`));
                    }
                }
            });
            setTimeout(() => {
                ref.unsubscribe();
                const err = new Error(`Request timeout`);
                err.code = 'ETIMEOUT';
                reject(err);
            }, timeout > 200 ? timeout : 200).unref();
            return super.send(host, port, data).catch((err) => {
                ref.unsubscribe();
                reject(err);
            });
        });
    }
    process(raw, remote) {
        try {
            const pos = new smart_cursor_1.SmartCursor();
            const header = deserializer_1.header(raw, pos);
            switch (header.serviceId) {
                case 518: {
                    const channel = deserializer_1.channel(raw, pos);
                    const sender = deserializer_1.hpai(raw, pos);
                    const response = deserializer_1.connectResponse(raw, pos);
                    return this.events.emit('query', tslib_1.__assign({}, header, channel, sender, response), remote);
                }
                case 520: {
                    const channel = deserializer_1.channel(raw, pos);
                    return this.events.emit('query', tslib_1.__assign({}, channel), remote);
                }
                case 1057: {
                    const seqn = deserializer_1.seqnum(raw, pos);
                    return this.events.emit('query', tslib_1.__assign({}, seqn), remote);
                }
                case 1056: {
                    const seqn = deserializer_1.seqnum(raw, pos);
                    const cemi = deserializer_1.tunnelCemi(raw, pos);
                    this.send(remote.address, remote.port, serializer_1.ack(seqn.seqn, seqn.channelId, 0));
                    return this.events.emit('query', tslib_1.__assign({}, cemi, seqn), remote);
                }
                case 522: {
                    const channel = deserializer_1.channel(raw, pos);
                    return this.events.emit('query', tslib_1.__assign({}, channel), remote);
                }
                default: throw new Error(`Failed to process ${header.serviceId}`);
            }
        }
        catch (err) {
            return this.events.emit('unprocessed', err, raw, remote);
        }
    }
}
exports.QueryManager = QueryManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9xdWVyeS1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsdURBRThCO0FBQzlCLHVEQUU4QjtBQUM5QixpREFPd0I7QUFDeEIsNkNBRXNCO0FBU3RCLGtCQUEwQixTQUFRLDBCQUFXO0lBQzNDLE9BQU8sQ0FBQyxPQUFlLENBQUM7UUFFdEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHO1lBQ25DLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUVsQixNQUFNLEdBQUcsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUlELE9BQU8sQ0FDTCxJQUFZLEVBQUUsSUFBWSxFQUFFLElBQVksRUFDeEMsTUFBZ0QsRUFBRSxPQUFnQjtRQUVsRSxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTTtZQUVwQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUF5QixPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTTtnQkFFakUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzFCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBYyxDQUFDLENBQUMsQ0FBQzt3QkFDcEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNqQixDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNOLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsS0FBSyxDQUFD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LEdBQTBCLEVBQUUsQ0FBQztvQkFDaEMsTUFBTSxPQUFPLEdBQUcsc0JBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQ3RDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLHVCQUFPLE9BQU8sR0FBSSxNQUFNLENBQUMsQ0FBQztnQkFDM0QsQ0FBQztnQkFDRCxTQUFTLE1BQU0sSUFBSSxLQUFLLENBQUMscUJBQXFCLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLENBQUM7UUFDSCxDQUFFO1FBQUEsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMzRCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBdEZELG9DQXNGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJlbW90ZUluZm8sXG59IGZyb20gJ2RncmFtJztcbmltcG9ydCB7XG4gIEFzeW5jU29ja2V0LFxufSBmcm9tICcuL3V0aWxzL2FzeW5jLXNvY2tldCc7XG5pbXBvcnQge1xuICBTbWFydEN1cnNvcixcbn0gZnJvbSAnLi91dGlscy9zbWFydC1jdXJzb3InO1xuaW1wb3J0IHtcbiAgY2hhbm5lbCBhcyByZWFkQ2hhbm5lbCxcbiAgY29ubmVjdFJlc3BvbnNlLFxuICBoZWFkZXIgYXMgcmVhZEhlYWRlcixcbiAgaHBhaSxcbiAgc2VxbnVtLFxuICB0dW5uZWxDZW1pLFxufSBmcm9tICcuL2Rlc2VyaWFsaXplcic7XG5pbXBvcnQge1xuICBhY2ssXG59IGZyb20gJy4vc2VyaWFsaXplcic7XG5pbXBvcnQge1xuICBTZXJ2aWNlLFxuICBTdGF0dXMsXG59IGZyb20gJy4vY29uc3RhbnRzJztcblxuLyoqXG4gKiBNYW5hZ2VzIGlvIHNlcnZlciBxdWVyaWVzIGFuZCB0cmFja3MgcmVzb2x1dGlvbiBvZiBtYXBwYWJsZSByZXF1ZXN0c1xuICovXG5leHBvcnQgY2xhc3MgUXVlcnlNYW5hZ2VyIGV4dGVuZHMgQXN5bmNTb2NrZXQge1xuICBjb25uZWN0KHBvcnQ6IG51bWJlciA9IDAgLyogT1MgYXNzaWduZWQgcG9ydCAqLyk6IFByb21pc2U8UmVtb3RlSW5mbz4ge1xuICAgIC8vIGZvcndhcmQgcmF3IGRhdGEgZm9yIHByb2Nlc3NpbmdcbiAgICBjb25zdCByZWYgPSBzdXBlci5vbigncmF3JywgdGhpcy5wcm9jZXNzLmJpbmQodGhpcykpO1xuICAgIHJldHVybiBzdXBlci5jb25uZWN0KHBvcnQpLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJlZi51bnN1YnNjcmliZSgpO1xuICAgICAgLy8gcHJvcGFnYXRlIGVycm9yIHRvIHRoZSBjYWxsZXJcbiAgICAgIHRocm93IGVycjtcbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogQ3JlYXRlcyBhIG1hcGFibGUgcmVxdWVzdCB0byB0cmFjayByZXNwb25zZXMgd2l0aCB0aW1lb3V0XG4gICAqL1xuICByZXF1ZXN0PFQ+KFxuICAgIGhvc3Q6IHN0cmluZywgcG9ydDogbnVtYmVyLCBkYXRhOiBCdWZmZXIsXG4gICAgc2VsZWN0OiAocmVzOiBULCBzZW5kZXI/OiBSZW1vdGVJbmZvKSA9PiBib29sZWFuLCB0aW1lb3V0PzogbnVtYmVyLFxuICApIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8VD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8ga2VlcCByZWYgdG8gdW5zdWIgdG8gYXZvaWQgYSBtZW1vcnkgbGVha1xuICAgICAgY29uc3QgcmVmID0gdGhpcy5vbjxUICYgeyBzdGF0dXM6IG51bWJlciB9PigncXVlcnknLCAocXVlcnksIHJlbW90ZSkgPT4ge1xuICAgICAgICAvLyBtYXAgcmVzcG9uc2UgdG8gdGhlIHJlcXVlc3RcbiAgICAgICAgaWYgKHNlbGVjdChxdWVyeSwgcmVtb3RlKSkge1xuICAgICAgICAgIGlmIChxdWVyeS5zdGF0dXMgPT09IFN0YXR1cy5Ob0Vycm9yKSB7XG4gICAgICAgICAgICByZXNvbHZlKHF1ZXJ5KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgUmVxdWVzdCBlcnJvciAke3F1ZXJ5LnN0YXR1c31gKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIHNldCB0aW1lb3V0IGlmIG5vIHJlc3BvbnNlIHdpdGhpbiBnaXZlbiB0aW1lXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVmLnVuc3Vic2NyaWJlKCk7IC8vIGF2b2lkIG1lbW9yeSBsZWFrXG4gICAgICAgIGNvbnN0IGVycjogTm9kZUpTLkVycm5vRXhjZXB0aW9uID0gbmV3IEVycm9yKGBSZXF1ZXN0IHRpbWVvdXRgKTtcbiAgICAgICAgZXJyLmNvZGUgPSAnRVRJTUVPVVQnO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0sIHRpbWVvdXQgPiAyMDAgPyB0aW1lb3V0IDogMjAwKS51bnJlZigpOyAvLyB1bnJlZiB0aW1lb3V0IHRvIGxldCBub2RlIGV4aXRcbiAgICAgIC8vIG1ha2UgcmVxdWVzdCBhbmQgcHJvcGFnYXRlIGVycm9yc1xuICAgICAgcmV0dXJuIHN1cGVyLnNlbmQoaG9zdCwgcG9ydCwgZGF0YSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICByZWYudW5zdWJzY3JpYmUoKTsgLy8gYXZvaWQgbWVtb3J5IGxlYWtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogUHJvY2Vzc2VzIHJhdyBtZXNzYWdlcyBmcm9tIHNvY2tldCBzdHJlYW1cbiAgICovXG4gIHByaXZhdGUgcHJvY2VzcyhyYXc6IEJ1ZmZlciwgcmVtb3RlOiBSZW1vdGVJbmZvKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBvcyA9IG5ldyBTbWFydEN1cnNvcigpO1xuICAgICAgY29uc3QgaGVhZGVyID0gcmVhZEhlYWRlcihyYXcsIHBvcyk7XG4gICAgICBzd2l0Y2ggKGhlYWRlci5zZXJ2aWNlSWQpIHtcbiAgICAgICAgY2FzZSBTZXJ2aWNlLkNvbm5lY3RSZXNwb25zZToge1xuICAgICAgICAgIGNvbnN0IGNoYW5uZWwgPSByZWFkQ2hhbm5lbChyYXcsIHBvcyk7XG4gICAgICAgICAgY29uc3Qgc2VuZGVyID0gaHBhaShyYXcsIHBvcyk7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBjb25uZWN0UmVzcG9uc2UocmF3LCBwb3MpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50cy5lbWl0KCdxdWVyeScsIHtcbiAgICAgICAgICAgIC4uLmhlYWRlciwgLi4uY2hhbm5lbCwgLi4uc2VuZGVyLCAuLi5yZXNwb25zZSxcbiAgICAgICAgICB9LCByZW1vdGUpO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgU2VydmljZS5Db25uZWN0U3RhdGVSZXNwb25zZToge1xuICAgICAgICAgIGNvbnN0IGNoYW5uZWwgPSByZWFkQ2hhbm5lbChyYXcsIHBvcyk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRzLmVtaXQoJ3F1ZXJ5JywgeyAuLi5jaGFubmVsIH0sIHJlbW90ZSk7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBTZXJ2aWNlLlR1bm5lbGluZ0Fjazoge1xuICAgICAgICAgIGNvbnN0IHNlcW4gPSBzZXFudW0ocmF3LCBwb3MpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50cy5lbWl0KCdxdWVyeScsIHsgLi4uc2VxbiB9LCByZW1vdGUpO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgU2VydmljZS5UdW5uZWxpbmdSZXF1ZXN0OiB7XG4gICAgICAgICAgY29uc3Qgc2VxbiA9IHNlcW51bShyYXcsIHBvcyk7XG4gICAgICAgICAgY29uc3QgY2VtaSA9IHR1bm5lbENlbWkocmF3LCBwb3MpO1xuICAgICAgICAgIC8vIHJlcGx5IGFjayB0byBpbmRpY2F0ZSBzdWNjZXNzZnVsIHJlY2VwdGlvbiBvZiB0aGUgbWVzc2FnZVxuICAgICAgICAgIHRoaXMuc2VuZChyZW1vdGUuYWRkcmVzcywgcmVtb3RlLnBvcnQsIGFjayhcbiAgICAgICAgICAgIHNlcW4uc2Vxbiwgc2Vxbi5jaGFubmVsSWQsIFN0YXR1cy5Ob0Vycm9yLFxuICAgICAgICAgICkpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50cy5lbWl0KCdxdWVyeScsIHsgLi4uY2VtaSwgLi4uc2VxbiB9LCByZW1vdGUpO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgU2VydmljZS5EaXNjb25uZWN0UmVzcG9uc2U6IHtcbiAgICAgICAgICBjb25zdCBjaGFubmVsID0gcmVhZENoYW5uZWwocmF3LCBwb3MpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50cy5lbWl0KCdxdWVyeScsIHsgLi4uY2hhbm5lbCB9LCByZW1vdGUpO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHByb2Nlc3MgJHtoZWFkZXIuc2VydmljZUlkfWApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuZXZlbnRzLmVtaXQoJ3VucHJvY2Vzc2VkJywgZXJyLCByYXcsIHJlbW90ZSk7XG4gICAgfVxuICB9XG59XG4iXX0=